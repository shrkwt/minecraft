<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Shaka Player Project</title>

    <!-- Shaka Player Libraries
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.13.2/shaka-player.compiled.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.13.2/shaka-player.ui.min.js"></script>-->
    <script src="shaka-player.compiled.js"></script>
    <script src="shaka-player.ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mux.js@6.2.0/dist/mux.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>

    <!-- Shaka Player CSS -->
    <link rel="stylesheet" href="controls.css" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./playerTheme.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet" />

    <!-- Icons -->
    <link type="image/png" rel="shortcut icon" href="//gaminglnk.eu.org/assets/img/favicon-player.png">
    <link type="image/png" rel="icon" href="//gaminglnk.eu.org/assets/img/favicon-player.png">
    <link type="image/png" rel="apple-touch-icon" href="//gaminglnk.eu.org/assets/img/favicon-player.png">

    <style>
        body {
            font-family: 'DM Sans', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #000;
        }

        #video-container {
            width: 80%;
            max-width: 900px;
        }

        video {
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>

    <!-- Shaka Player Container -->
        <div class="youtube-theme" id="video-container" data-shaka-player-container
            data-shaka-player-cast-receiver-id="07AEE832">
            <video poster='https://picsum.photos/1200/675.webp?grayscale' data-shaka-player id="video"></video>
        </div>

    <script>
        //////////////////////////////////////////////////////////////////////////////////////////////////////////

        function getParameter(parameterName) {
            let parameters = new URLSearchParams(window.location.search);
            return parameters.get(parameterName);
        }

        // Code to trigger fullscreen in the presence of "?fullscreen"
        window.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has("fullscreen")) {
                const wrapper = document.querySelector(".wrapper");
                const videoContainer = document.querySelector("#video-container");

                if (wrapper && videoContainer) {
                    // Move the video container to the body
                    document.body.appendChild(videoContainer);
                    // Remove the wrapper
                    wrapper.remove();
                }
            }
        });

        //Get video url and loading animation
        var manifestUri = getParameter("link");
        const svgPath = './spinner.svg';

        //////////////////////////////////////////////////////////////////////////////////////////////////////////
        
        //Loading the shaka player
        document.addEventListener('shaka-ui-loaded', init);
        function init() {
            const video = document.getElementById('video');
            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();

            const config = {
                controlPanelElements: ['play_pause', 'time_and_duration', 'mute', 'volume', 'spacer', 'picture_in_picture', 'overflow_menu', 'fullscreen'],
                overflowMenuButtons: ['quality', 'captions', 'language', 'playback_rate', 'picture_in_picture', 'cast', 'airplay', 'loop', 'save_video_frame'],
                statisticsList: [
                    "width",
                    "height",
                    "playTime",
                    "bufferingTime",
                    "decodedFrames",
                    "corruptedFrames",
                ],
                addBigPlayButton: false,
                seekBarColors: {
                    base: "rgba(255, 255, 255, 0.3)",
                    buffered: "rgba(255, 255, 255, 0.54)",
                    /*played: "rgb(255, 176, 59)",*/
                    played: "rgb(255, 0, 0)",
                },
                volumeBarColors: {
                    base: "rgba(255, 255, 255, 0.3)",
                    level: "rgb(255, 255, 255)",
                },
            };
            ui.configure(config);
            // player.configure("streaming.forceTransmuxTS", true); // only for v4.2.0 and below

            // Attach player and UI to the window to make it easy to access in the JS console.
            window.player = player;
            window.ui = ui;

            // Listen for error events.
            player.addEventListener('error', onPlayerErrorEvent);
            controls.addEventListener('error', onUIErrorEvent);

            try {
                player.load(manifestUri).then(() => {
                    console.log('The video has now been loaded!');
                });
            } catch (error) {
                onPlayerError(error);
            }

            $(document).ready(function () {
                // Update static text replacements
                $(".shaka-overflow-menu-button").text("settings");
                $(".shaka-back-to-overflow-button .material-icons-round").text("arrow_back_ios_new");

                // Replace icons for various buttons
                const buttonIcons = {
                    "shaka-language-button": "record_voice_over",
                    "shaka-resolution-button": "tune",
                    "shaka-playbackrate-button": "slow_motion_video",
                    "shaka-pip-button": "pip",
                    "shaka-cast-button": "cast",
                    "shaka-loop-button": "repeat",
                    "shaka-caption-button": "subtitles",
                    "shaka-save.video-frame-button": "panorama"
                };

                $.each(buttonIcons, (buttonClass, iconName) => {
                    $(`button.${buttonClass} label`).each(function () {
                        const $label = $(this);
                        if (!$label.find('.material-icons-round').length) {
                            $label.prepend(`<b class="material-icons-round">${iconName}</b>`);
                        }
                    });
                });

                document.querySelectorAll('button[aria-label="Save video frame"] label').forEach((button) => {
                    const span = document.createElement('b');
                    span.className = 'material-icons-round';
                    span.textContent = 'panorama';
                    button.insertBefore(span, button.firstChild);
                });

                document.querySelectorAll('.shaka-forward-rewind-container-icon').forEach((element) => {
                    element.classList.add('material-icons-round');
                });


                // Replace "Undetermined" text with "Default"
                const replaceUndeterminedText = () => {
                    $('div.shaka-audio-languages button span.shaka-chosen-item, button.shaka-language-button label span.shaka-current-selection-span')
                        .filter((_, el) => $(el).text().trim() === "Undetermined")
                        .text("Default");
                };
                replaceUndeterminedText();

                const textObserver = new MutationObserver(replaceUndeterminedText);
                textObserver.observe(document.body, {
                    subtree: true,
                    childList: true,
                    characterData: true
                });
            });

        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////////
        // Replace spinner SVG on shaka to get the mod animation.
        function replaceSpinnerSVG() {
            fetch(svgPath)
                .then(response => response.text())
                .then((svgContent) => {
                    document.querySelectorAll('.shaka-spinner-svg').forEach((svgElement) => {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = svgContent.trim();
                        const newSVG = tempDiv.querySelector('svg');
                        if (newSVG) {
                            svgElement.replaceWith(newSVG);
                        }
                    });
                })
                .catch(console.error);
        }
        const observerConfig = {
            subtree: true,
            attributes: true,
            attributeFilter: ["class"]
        };
        const spinnerObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                const $target = $(mutation.target);
                if ($target.hasClass("shaka-spinner-container") && $target.hasClass("shaka-hidden")) {
                    replaceSpinnerSVG();
                }
            });
        });
        spinnerObserver.observe(document.body, observerConfig);

        //////////////////////////////////////////////////////////////////////////////////////////////////////////
        //Fetch errors
        function onPlayerErrorEvent(event) {
            onPlayerError(event.detail);
        }

        function onPlayerError(error) {
            console.error('Error code', error.code, 'object', error);
        }

        function onUIErrorEvent(event) {
            onPlayerError(event.detail);
        }

    </script>

</body>

</html>